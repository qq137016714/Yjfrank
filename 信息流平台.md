
信息流脚本管理与数据分析平台
PRD 产品需求文档  v3.0

新增内容：技术栈评估 · 局域网部署方案 · 多Agent提示词规划 · 分阶段迭代路线图
面向 AI 多 Agent 协作团队  |  2026年


变更日志  v2.0 → v3.0
新增章节	内容概述
第一章（新增）	技术栈深度评估：分析 Next.js+TypeScript+React+Tailwind v4+shadcn/ui+SQLite 对本项目的适配性，并给出调整建议
第二章（新增）	局域网部署方案：包含服务器配置、局域网存储、访问方式、环境变量规划
第三章（新增）	多Agent子代理规划：每个开发岗位的系统提示词、技能要求、协作规范、一致性保障机制
第四章（新增）	分阶段迭代路线图：7个版本节点（v0.1→v3.0），从数据分析→脚本管理→AI二创逐步交付，每版本含验收标准
第五章（新增）	EXCEL上传状态提示机制：完整的上传→解析→录入状态反馈设计
后续章节	v2.0全部内容保留（账号系统、脚本管理、数据分析、AI二创、测试等），在分阶段路线图中按版本分配



一、技术栈评估与确认
你提出的技术栈：Next.js + TypeScript + React + Tailwind CSS v4 + shadcn/ui + SQLite
以下逐项分析每个技术对本项目的适配性，并给出最终建议。

1.1 整体评估结论
✅ 总体结论：适合，附条件接受
该技术栈整体适合本项目，适合一个小团队内网运行的全栈Web应用。主要需要关注的点是 SQLite 的并发写入限制（见下文分析），以及 Tailwind CSS v4 目前仍处于新版本阶段的潜在兼容风险。建议采用下方「微调后方案」确保稳定性。

1.2 逐项技术分析
Next.js 15（App Router）
维度	评估
适配性	✅ 非常适合。Next.js App Router 天然支持前后端一体化，API Routes 可作为后端，SSR/SSG 提升首屏速度，无需单独搭建 Express/FastAPI 后端服务
局域网部署	✅ 支持。next start 启动生产服务器，绑定局域网 IP 即可全组访问，无需额外配置
与本项目匹配点	数据分析页图表量大，SSR可避免客户端白屏；API Routes处理EXCEL解析、数据聚合逻辑；文件上传接口天然支持
注意事项	⚠️ 建议使用 Next.js 15 稳定版，避免使用 canary 版本。App Router 中的 Server Actions 可简化表单提交逻辑，推荐使用

TypeScript
维度	评估
适配性	✅ 强烈推荐。多Agent协作开发时，TypeScript的类型系统能极大减少不同Agent之间的接口理解偏差
本项目核心价值	脚本数据模型、EXCEL解析结果、API返回结构等需要精确类型定义，避免数据字段错误
注意事项	需在项目初始化时统一定义核心类型文件（types/index.ts），所有Agent共用，不可各自定义

React 19
维度	评估
适配性	✅ 适合，Next.js 15 内置 React 19
本项目核心价值	数据看板、图表组件、弹窗系统、表单交互均基于React组件体系，复用性强
注意事项	React 19 的 use() hook 和 Server Components 是新特性，Agent需统一约定哪些组件为 Server Component，哪些为 Client Component（含 'use client' 声明）

Tailwind CSS v4
⚠️ Tailwind CSS v4 风险提示
Tailwind v4 于2025年正式发布，配置方式与v3有较大差异（如取消 tailwind.config.js，改用CSS变量配置）。shadcn/ui 对 Tailwind v4 的官方支持在2025年中已跟进，但部分社区插件可能尚未完全兼容。建议：若团队熟悉v4，可使用；若希望最大化稳定性，可降级使用 Tailwind CSS v3.4。最终由开发Agent负责人在初始化时确认版本。

shadcn/ui
维度	评估
适配性	✅ 非常适合。shadcn/ui 是「复制到项目中」的组件库，而非npm包依赖，可完全定制
本项目核心价值	Button、Input、Select、Dialog、Table、Toast、Tabs等组件直接使用，与PRD的组件规范高度吻合；图标使用 lucide-react（shadcn默认内置），满足PRD强制要求
注意事项	shadcn/ui 组件需在项目初始化时统一安装，所有Agent不可自行引入其他UI库

SQLite（via Prisma ORM）
⚠️ SQLite 并发写入限制分析
SQLite 是单文件数据库，写操作是串行的（WAL模式下并发读没问题）。本项目使用场景：内网小团队（推测5-20人同时在线），写操作主要集中在「上传脚本」和「管理员上传EXCEL」，并发写入量极低。结论：对本项目完全够用，不会出现并发瓶颈。但有一点需要注意：EXCEL解析是CPU密集型操作，建议在API Route中使用异步队列处理，避免长时间阻塞。

维度	评估
适配性	✅ 适合本项目规模。内网小团队，并发写入量低，SQLite WAL模式完全满足需求
局域网存储	✅ SQLite数据库文件（.db）直接存储在服务器本地，可映射到局域网共享存储
ORM建议	✅ 强烈建议使用 Prisma ORM，类型安全，与TypeScript完美配合，自动生成类型定义
备份策略	每天定时备份 .db 文件到局域网另一台机器或NAS，防止数据丢失
注意事项	数据库文件路径需通过环境变量配置（DATABASE_URL），便于局域网部署切换存储位置

1.3 最终推荐技术栈（微调后方案）
层级	技术	版本建议	说明
框架	Next.js	15.x 稳定版	全栈框架，App Router，API Routes作后端
语言	TypeScript	5.x	全项目强制TypeScript，统一类型定义
UI框架	React	19.x（Next.js内置）	
样式	Tailwind CSS	v4.x（或降级v3.4）	由前端Agent确认版本兼容性后统一
组件库	shadcn/ui	最新版	安装时指定Tailwind版本对应分支
图标	lucide-react	最新版	PRD强制要求，shadcn内置依赖
ORM	Prisma	5.x	类型安全，自动迁移，生成TypeScript类型
数据库	SQLite	通过Prisma管理	文件存储，路径可配置至局域网存储
EXCEL解析	xlsx (SheetJS)	最新版	解析.xlsx/.xls文件
图表	Recharts	2.x	基于React，与Next.js兼容好
状态管理	Zustand	4.x	轻量，适合中等复杂度状态管理
表单	React Hook Form + Zod	最新版	表单校验，类型安全
HTTP客户端	原生fetch（Next.js内置）		Server Actions + API Routes，无需axios
认证	NextAuth.js（Auth.js）	v5.x	JWT鉴权，支持Credentials Provider（账号密码登录）


二、局域网部署方案
2.1 部署架构
本项目采用「单机部署 + 局域网访问」模式，无需购买云服务器，直接运行在公司内网一台专用电脑（或服务器）上。

组件	部署位置	说明
Next.js 应用	公司内网服务器（任意一台Windows/Mac/Linux电脑）	运行 next start，监听局域网IP
SQLite 数据库	服务器本地磁盘（或局域网NAS映射盘）	单文件 .db，路径通过环境变量配置
EXCEL文件存储	服务器本地 /uploads 目录（或局域网NAS）	上传的EXCEL原始文件备份
局域网访问	全组编导通过 http://192.168.x.x:3000 访问	无需公网，局域网内直接访问

2.2 服务器最低配置要求
配置项	最低要求	推荐配置
操作系统	Windows 10/11、macOS 12+、Ubuntu 20.04+	Ubuntu 22.04 LTS（最稳定）
CPU	2核	4核以上
内存	4GB RAM	8GB RAM
磁盘	20GB可用空间	100GB（存储EXCEL文件备份）
网络	有线局域网（100Mbps+）	千兆有线
Node.js	18.x LTS 以上	20.x LTS

2.3 环境变量配置（.env.local）
💻 项目根目录 .env.local 文件
# 数据库路径（可指向局域网NAS映射的本地路径）
DATABASE_URL="file:./data/production.db"

# 如使用NAS映射盘（Windows示例）
# DATABASE_URL="file:Z:/信息流平台/production.db"

# NextAuth 密钥（随机生成32位字符串）
NEXTAUTH_SECRET="your-random-32-char-secret-here"

# 局域网访问地址（改为服务器实际IP）
NEXTAUTH_URL="http://192.168.1.100:3000"

# EXCEL文件上传目录
UPLOAD_DIR="./uploads"

# 端口（默认3000，可修改）
PORT=3000

2.4 启动与访问
💻 服务器启动命令
# 1. 安装依赖
npm install

# 2. 数据库初始化（首次运行）
npx prisma migrate deploy
npx prisma db seed   # 初始化管理员账号和标签数据

# 3. 构建生产版本
npm run build

# 4. 启动服务（绑定所有网卡，局域网可访问）
npm start -- --hostname 0.0.0.0 --port 3000

# 5. 开机自启（Linux推荐使用PM2）
npm install -g pm2
pm2 start npm --name 'xlpt-platform' -- start
pm2 startup && pm2 save

📌 全组访问方式
服务器启动后，全组编导在浏览器输入 http://[服务器局域网IP]:3000 即可访问。服务器局域网IP可通过 ipconfig（Windows）或 ifconfig（Linux/Mac）查看。建议在公司路由器给服务器设置固定IP（DHCP静态绑定），避免IP变动。

2.5 存储方案
存储类型	方案	路径配置
数据库文件	SQLite .db 文件，存储在服务器本地或NAS	DATABASE_URL 环境变量配置
EXCEL上传文件	服务器 /uploads 目录，按日期自动分子目录	UPLOAD_DIR 环境变量配置
静态资源	Next.js /public 目录	代码内置，无需额外配置
数据库备份	每日凌晨自动复制 .db 文件至备份目录	可用 cron job 或 Windows任务计划实现


三、多 Agent 子代理规划
本章为项目中每个开发岗位的 AI Agent 提供标准化系统提示词（System Prompt）、技能要求和协作规范。产品负责人在启动各 Agent 时，将对应的系统提示词复制粘贴至 Agent 的 System Prompt 区域即可。

📌 Agent一致性原则
所有Agent必须遵循：(1) 共用 types/index.ts 的类型定义，不可自行新增类型；(2) 共用 PRD v3.0 文档为唯一需求来源；(3) 任何超出PRD范围的功能须先报产品负责人确认；(4) 所有代码提交前须通过 TypeScript 编译检查（tsc --noEmit）；(5) 组件命名、文件命名遵循统一约定（见各Agent提示词）。

🏗️ Agent 1 — 架构总监 & 项目负责Agent
【角色定位】
你是本项目的首席架构师和项目总负责Agent。你负责项目初始化、
技术架构决策、各Agent工作的最终整合，以及解决跨Agent的技术冲突。

【核心职责】
1. 初始化整个Next.js项目结构（见下方目录规范）
2. 编写并维护 types/index.ts（全项目共用类型定义文件）
3. 配置 Prisma schema 和数据库迁移文件
4. 配置 tailwind.config / 全局CSS变量 / shadcn初始化
5. 负责环境变量管理（.env.local 模板维护）
6. 审查其他Agent提交的代码，发现类型错误、架构偏差时及时纠正
7. 在每个版本节点（v0.1/v0.2等）负责集成测试和部署验证

【项目目录规范（必须严格执行）】
  /app                    — Next.js App Router 路由
  /app/api               — API Routes (后端接口)
  /app/(auth)            — 登录/注册页面
  /app/(main)/dashboard  — 数据分析页
  /app/(main)/scripts    — 脚本管理页
  /app/(main)/ai-create  — AI二创页
  /components/ui         — shadcn/ui 基础组件（不可修改）
  /components/common     — 项目级通用组件
  /components/dashboard  — 数据分析页专用组件
  /components/scripts    — 脚本管理页专用组件
  /components/ai-create  — AI二创页专用组件
  /lib                   — 工具函数、db客户端、auth配置
  /lib/db.ts             — Prisma Client 单例
  /lib/auth.ts           — NextAuth 配置
  /lib/excel.ts          — EXCEL解析核心逻辑
  /lib/matching.ts       — 脚本名模糊匹配核心逻辑
  /lib/stats.ts          — 数据统计聚合核心逻辑
  /types/index.ts        — 全项目共用类型（只有你维护）
  /prisma/schema.prisma  — 数据库表结构
  /prisma/seed.ts        — 初始数据（管理员账号+标签数据）

【技术栈约束】
Next.js 15 + TypeScript 5 + Tailwind CSS v4 + shadcn/ui + SQLite(Prisma) + NextAuth v5

【与其他Agent的协作规范】
- 每个Agent开始工作前，必须先阅读你维护的 types/index.ts
- 其他Agent不可修改 types/index.ts，有类型需求须向你提出
- 其他Agent不可修改 /components/ui 下的shadcn基础组件
- 发现代码冲突时，你有最终裁定权

⚙️ Agent 2 — 后端工程师 Agent
【角色定位】
你是本项目的后端开发Agent。你负责所有API Routes的实现、
数据库操作逻辑、EXCEL解析处理、数据统计聚合算法。

【核心职责】
1. 实现 /app/api 下的所有API端点
2. 实现 /lib/excel.ts（EXCEL解析：SheetJS读取、列名校验、模糊匹配）
3. 实现 /lib/matching.ts（脚本名模糊匹配算法，注意边界问题）
4. 实现 /lib/stats.ts（多期数据聚合、重算字段、父子脚本消耗汇总）
5. 实现 NextAuth Credentials Provider（账号密码登录）
6. 实现文件上传接口，支持进度反馈和状态回调

【API设计规范】
所有API返回统一结构：
  成功：{ success: true, data: T, message?: string }
  失败：{ success: false, error: string, code?: string }
HTTP状态码：200成功 / 400参数错误 / 401未登录 / 403无权限 / 500服务器错误

【数据匹配核心逻辑（必须严格执行）】
脚本名模糊匹配规则：EXCEL A列「素材名」包含脚本名字符串即算匹配
边界处理：「脚本3」不应错误匹配「脚本30」，需做边界词检测
建议实现：检查脚本名在素材名中的前后字符，若前后都是数字则不匹配

【多期数据聚合规则（严格按PRD执行）】
加算字段：总成本、展示数、点击数、获客数、低价课人数等（直接累加）
平均字段：点击率、完播率、转化率等（多期算术平均）
重算字段：获客成本=总成本÷总获客数、ROI=高价课流水÷总成本等
每次新上传EXCEL后，触发全量重新计算并更新 script_stats 表

【性能要求】
EXCEL解析须异步处理，上传接口立即返回taskId，
前端通过轮询 /api/excel/status?taskId=xxx 查询进度
任务状态：pending → parsing → matching → calculating → done | error

【你不负责的部分】
前端UI组件、样式、图表 — 交由前端Agent

🎨 Agent 3 — 前端工程师 Agent
【角色定位】
你是本项目的前端开发Agent。你负责所有页面组件的实现、
用户交互逻辑、图表可视化、状态管理和API调用集成。

【核心职责】
1. 实现三个主要页面：数据分析页 / 脚本管理页 / AI二创页
2. 实现顶部导航栏（路由高亮、用户信息展示、退出登录）
3. 实现所有弹窗（Modal）、Toast提示、Loading状态
4. 实现图表组件（使用 Recharts，所有图表须支持响应式）
5. 实现EXCEL上传区域及完整状态提示流程
6. 实现脚本表单（含动态显示的衍生字段、标签多选）

【UI规范（强制）】
- 所有图标：lucide-react（禁止使用其他图标库）
- 组件库：shadcn/ui（禁止引入其他UI组件库）
- 颜色：严格使用PRD第二章色值，不可自行新增颜色
- 字体：使用 Inter（通过 next/font 引入）

【组件命名规范】
- 页面级组件：PascalCase，如 DashboardPage.tsx
- 通用组件：PascalCase，如 ScriptCard.tsx
- hooks：camelCase，use前缀，如 useScriptList.ts
- 工具函数：camelCase，如 formatCurrency.ts

【状态管理规范】
- 服务器数据（列表、详情）：使用 SWR 或 React Query 管理，支持自动刷新
- 表单状态：React Hook Form
- 全局UI状态（Toast、弹窗）：Zustand store
- URL状态（筛选、分页）：useSearchParams

【Client / Server Component 约定】
- 有交互、有state、用useEffect：必须加 'use client'
- 纯数据展示、无交互：优先写Server Component（不加'use client'）
- 图表组件（Recharts）：必须加 'use client'（Recharts不支持SSR）

【你不负责的部分】
API Routes实现、数据库操作 — 交由后端Agent

🖌️ Agent 4 — UI/UX 设计 Agent
【角色定位】
你是本项目的UI/UX设计Agent。你负责产出Figma设计稿和设计规范，
为前端Agent提供精确的视觉参考，确保产品视觉质量。

【核心职责】
1. 产出Figma全页面设计稿（数据分析页/脚本管理页/AI二创页/登录注册页）
2. 建立Figma组件库（Button/Input/Select/Table/Modal/Toast/Card等）
3. 产出设计规范文档（颜色/字体/间距/圆角/阴影系统）
4. 为每个交互状态提供设计稿（hover/focus/disabled/error/loading）
5. 产出EXCEL上传状态流程的完整UI设计（4个状态的视觉方案）

【设计约束（必须严格遵守）】
颜色系统：
  主色：#1E40AF  主色浅：#3B82F6  主色极浅：#EFF6FF
  成功：#16A34A  警告：#D97706  错误：#DC2626
  AI紫：#7C3AED  背景：#F9FAFB  卡片：#FFFFFF

字体：Inter（英文数字）+ 思源黑体/PingFang SC（中文）
圆角：按钮8px / 卡片12px / 弹窗12px
图标：lucide风格（线性图标，Stroke 1.5px）

【设计交付物清单】
□ 登录页、注册页
□ 导航栏（管理员态/编导态）
□ 数据分析页（含KPI卡片、图表区、智能摘要、单脚本弹窗）
□ 脚本管理页（列表视图 + 上传表单弹窗 + 详情弹窗）
□ AI二创页（授权弹窗 + 二创工作台4步流程）
□ EXCEL上传区域（上传中/解析中/录入中/成功/失败 5个状态）
□ 错误页面（404/500）

【与前端Agent的协作方式】
交付Figma链接后，在组件库中为每个组件标注：
  shadcn对应组件名、Tailwind class名、lucide图标名
这样前端Agent可以直接对应实现，减少沟通成本

🧪 Agent 5 — 测试工程师 Agent
【角色定位】
你是本项目的测试Agent。你负责在每个版本节点（v0.1/v0.2/v0.3/v1.0等）
执行验收测试，确保功能符合PRD要求，出具测试报告。

【测试执行时机】
每个版本的开发Agent声明「开发完成」后，你执行对应版本的测试用例。
测试通过 → 产品负责人确认 → 进入下一版本开发。
测试不通过 → 提交Bug报告 → 开发Agent修复 → 重新测试。

【测试用例来源】
PRD v3.0 第九章「测试要求」为基础测试用例库。
每个版本新增功能对应的测试用例，见第四章「分阶段迭代路线图」的验收标准。

【拟真数据测试（必测）】
产品负责人提供拟真EXCEL数据表后，你须执行：
  1. 上传拟真数据表，验证解析状态提示流程正确
  2. 验证模糊匹配结果是否与预期一致（逐条核对）
  3. 验证多期数据累积计算是否准确（手动计算对比）
  4. 验证父子脚本消耗聚合是否正确
  5. 验证边界匹配问题（「脚本3」不应匹配「脚本30」）

【测试报告格式】
每份报告包含：版本号、测试日期、测试人、
通过用例数/总用例数、失败用例详情（含复现步骤+截图描述）、
遗留问题清单、是否建议通过验收。

【Bug报告格式】
Bug标题 | 严重程度（P0/P1/P2） | 复现步骤 | 预期结果 | 实际结果 | 所属版本

【权限说明】
你有权要求任何开发Agent对Bug进行修复，
有权暂停版本进入下一阶段，直到当前版本测试通过。

🚀 Agent 6 — 部署运维 Agent
【角色定位】
你是本项目的部署运维Agent。你负责将项目成功部署到公司局域网服务器，
配置开机自启，确保全组编导可以稳定访问。

【核心职责】
1. 在服务器上配置 Node.js 运行环境（建议使用 nvm 管理版本）
2. 克隆项目代码，配置 .env.local 环境变量（见第二章2.3节）
3. 执行数据库初始化（prisma migrate deploy + prisma db seed）
4. 构建并启动项目（npm run build && npm start）
5. 使用 PM2 配置进程守护和开机自启
6. 验证局域网内其他电脑可以正常访问
7. 配置每日数据库自动备份脚本

【部署检查清单】
□ 服务器 Node.js 版本 >= 18.x
□ .env.local 已配置 DATABASE_URL、NEXTAUTH_SECRET、NEXTAUTH_URL
□ 数据库初始化完成（管理员账号可登录）
□ 项目构建成功（无报错）
□ 服务监听 0.0.0.0:3000（非127.0.0.1）
□ 局域网其他电脑浏览器可访问
□ PM2进程已启动，pm2 status 显示online
□ 服务器重启后PM2自动拉起服务
□ 数据库备份脚本已配置并测试

【常见问题排查】
无法访问：检查服务器防火墙是否放行3000端口
数据库错误：检查DATABASE_URL路径是否正确，目录是否有写权限
构建失败：检查Node.js版本，执行 npm install 重新安装依赖

【你不负责的部分】
代码开发、功能实现 — 交由对应开发Agent

3.7 Agent协作一致性保障机制
机制	说明	执行方
统一类型文件	所有Agent共用 types/index.ts，任何类型变更须通过架构Agent	架构Agent维护，其他Agent只读
API合约文档	后端Agent完成接口后，在 /docs/api.md 更新接口文档，前端Agent按此调用	后端Agent维护
组件规范文档	前端Agent在 /docs/components.md 记录已实现的组件名称和Props，其他Agent复用	前端Agent维护
PRD为唯一需求源	所有功能以PRD v3.0为准，口头需求不算，变更须更新PRD	产品负责人
每版本集成测试	每个版本节点，架构Agent负责将所有Agent的工作集成，测试Agent执行验收测试	架构Agent + 测试Agent
TypeScript编译门禁	任何代码提交前须通过 tsc --noEmit，有类型错误不允许合并	所有Agent


四、EXCEL上传状态提示机制（新增）
本章详细定义EXCEL数据上传全流程的状态反馈设计，确保管理员在每个阶段都有清晰的视觉反馈。

4.1 上传状态流程定义
阶段	状态名	触发条件	UI表现
等待上传	idle	页面初始状态	虚线边框上传区域，显示「点击或拖拽EXCEL文件至此上传」
文件选择中	selected	用户选中文件，尚未点击确认上传	展示文件名、文件大小，显示「开始上传」确认按钮
上传中	uploading	文件正在传输至服务器	蓝色进度条 + 「正在上传文件...」+ 百分比显示
文件验证中	validating	服务器收到文件，校验列名格式	蓝色旋转Spinner + 「正在验证文件格式...」
格式校验失败	invalid	列名不符合规范	红色错误提示框，显示具体哪列不匹配，文件不入库
数据解析中	parsing	逐行读取EXCEL数据	蓝色进度条（显示已处理行数/总行数）+「正在解析数据，请勿关闭页面...」
数据匹配中	matching	对每行数据进行脚本名模糊匹配	蓝色旋转Spinner + 「正在匹配脚本数据（X/Y条）...」
统计计算中	calculating	执行多期数据聚合重算	蓝色旋转Spinner + 「正在更新统计数据...」
上传成功	done	全流程完成	绿色成功提示框：「数据上传成功！本期数据已录入，共匹配 X 条脚本，更新 Y 项统计数据。」
上传失败	error	任意步骤出错	红色错误框，显示具体错误信息，提供「重试」按钮

4.2 前端实现要求
•上传区域使用「拖拽上传」+「点击选择」双模式，支持 .xlsx .xls 两种格式
•文件大小限制：100MB，超出给出明确提示
•上传进度条使用 XMLHttpRequest 或 fetch with ReadableStream 获取实时进度
•uploading 阶段之后的状态，通过轮询 /api/excel/status?taskId=xxx 接口获取（每2秒轮询一次）
•parsing 阶段显示实时行数进度：后端每处理100行更新一次进度，前端轮询获取
•全程不可关闭上传进度弹窗，需提示「请勿关闭页面」
•成功后自动刷新数据分析页的所有图表和统计数据

4.3 后端实现要求
•上传接口接收文件后立即返回 { taskId: string }，不阻塞等待
•异步处理队列：validating → parsing → matching → calculating → done
•在数据库（或内存缓存）中维护任务状态：{ taskId, status, progress, message, error }
•/api/excel/status?taskId=xxx 接口：返回当前任务状态和进度信息
•解析失败时记录具体错误（如「第3列列名应为「总成本」，实际为「cost」」），存入任务状态
•成功后自动触发 script_stats 表的全量重新计算


五、分阶段迭代路线图
按照「先数据分析 → 再脚本管理 → 最后AI二创」的顺序分阶段交付。每个版本节点都有明确的验收标准，确保每步可用、可确认。

📌 迭代原则
每个版本完成后，产品负责人须亲自在局域网环境中操作验收，确认「可用」后再启动下一版本开发。任何版本发现的问题须在当前版本修复完毕后再进入下一版本，不累积技术债。

v0.1  项目基础架构 + 账号系统
目标：项目能跑起来，管理员和编导可以注册登录
【开发范围】
▸ 架构Agent：初始化Next.js项目，配置TypeScript/Tailwind/shadcn，
  搭建目录结构，完成Prisma schema基础版（users表）
▸ 后端Agent：实现注册/登录API（NextAuth Credentials Provider）
▸ 前端Agent：实现登录页、注册页，顶部导航栏框架（空）
▸ 部署Agent：在公司服务器完成项目部署，验证局域网可访问

【不包含】
▸ 脚本功能、数据分析、AI二创（均为后续版本）

【验收标准（产品负责人确认以下全部通过）】
□ 在局域网任意一台电脑浏览器输入服务器IP:3000可以打开网站
□ 管理员账号（管理员/123456）可以成功登录
□ 新编导可以成功注册账号，注册后可以登录
□ 重复用户名注册，给出明确错误提示
□ 连续登录失败5次，账号被锁定，给出提示
□ 登录后顶部导航栏显示用户名，退出登录功能正常

v0.2  数据分析页 — EXCEL上传与解析
目标：管理员可以上传EXCEL，看到上传进度和状态反馈
【开发范围】
▸ 后端Agent：
  - 完善Prisma schema（excel_uploads、script_stats表）
  - 实现EXCEL上传接口（文件接收、格式校验、异步处理队列）
  - 实现列名校验逻辑（A-AV列名称核对）
  - 实现任务状态查询接口 /api/excel/status
  - 实现标准EXCEL模板下载接口
▸ 前端Agent：
  - 实现数据分析页框架（空白占位）
  - 实现EXCEL上传区域（拖拽+点击选择）
  - 实现完整的5阶段状态提示UI（idle/uploading/validating/parsing/done/error）
  - 实现轮询逻辑（每2秒查询任务状态）
  - 实现历史上传记录列表（管理员可见）

【验收标准】
□ 管理员可以上传标准格式EXCEL文件
□ 上传过程中可以看到「正在上传文件」进度条
□ 服务器收到文件后，显示「正在验证文件格式」
□ 格式正确后，显示「正在解析数据（X/Y行）」实时进度
□ 解析完成后，显示「数据上传成功」绿色提示
□ 上传格式错误的EXCEL，给出具体哪列不匹配的错误提示
□ 历史上传记录列表正常展示，管理员可删除某一期
□ 普通编导看不到上传按钮
□ 可下载标准EXCEL模板

v0.3  数据分析页 — 数据匹配与统计计算
目标：上传EXCEL后，可以看到脚本数据被自动匹配和计算
【重要前提】
▸ 产品负责人需在此阶段提供「拟真EXCEL测试数据表」
▸ 测试Agent使用拟真数据表执行完整验证

【开发范围】
▸ 后端Agent：
  - 实现Prisma schema完整版（scripts表基础版：仅name字段，用于匹配测试）
  - 实现脚本名模糊匹配算法（含边界处理）
  - 实现多期数据聚合算法（加算/平均/重算，按PRD5.3节处理策略）
  - 实现父子脚本消耗聚合逻辑
  - 实现 /api/stats 全平台统计摘要接口
  - 实现 /api/scripts/[name]/stats 单脚本统计数据接口
▸ 前端Agent（数据展示基础版）：
  - 实现KPI卡片区（总消耗/总获客/平均获客成本/ROI）
  - 实现智能摘要卡片（TOP3消耗/TOP3高价课流水等）
  - 实现消耗TOP10条形图（Recharts）
  - 实现单脚本查询搜索框和数据弹窗

【验收标准（须配合拟真数据测试）】
□ 上传拟真数据表后，数据分析页KPI数据更新
□ 消耗TOP10图表展示正确（与手动计算结果一致）
□ 「脚本3.mp4」被正确匹配到「脚本3」
□ 「脚本3」不被错误匹配到「脚本30」（边界测试）
□ 上传第二期数据后，总成本正确累加
□ 平均指标（点击率等）重新计算正确
□ 重算指标（获客成本=总成本÷总获客数）计算正确
□ ROI = 高价课流水 ÷ 总成本，计算正确
□ 单脚本查询弹窗展示该脚本所有维度数据

v1.0  数据分析页 — 完整版发布
目标：数据分析页全功能完整上线，可正式使用
【开发范围】
▸ 前端Agent：
  - 补充全部图表（ROI TOP10、获客数TOP10、标签消耗对比、渠道占比饼图、渠道ROI折线图）
  - 完善单脚本查询弹窗（渠道切换、父子脚本关联展示）
  - 完善智能摘要卡片（前/中/尾贴标签TOP3、衍生消耗TOP3父脚本）
  - 实现广告渠道分组数据切换（全渠道汇总↔按渠道查看）
▸ 后端Agent：
  - 完善按渠道分组的统计接口
  - 性能优化（大数据量下的查询速度）
▸ 测试Agent：
  - 执行完整功能测试（见PRD第九章8.1全部用例）
  - 性能测试（1000行EXCEL在30秒内处理完成）
  - 出具v1.0测试报告

【验收标准（产品负责人签收v1.0）】
□ 所有图表正常展示且数据准确
□ 单脚本查询弹窗全维度数据展示完整
□ 父子脚本关联在弹窗中正确展示
□ 按广告渠道切换视图功能正常
□ 测试Agent测试报告无P0/P1级Bug
□ 全组编导在自己电脑上可以流畅访问和使用数据分析页
□ ✅ 产品负责人正式确认：v1.0 数据分析功能可投入日常使用

v1.1  脚本管理页 — 基础版（上传+列表）
目标：编导可以上传脚本，查看脚本列表
【重要说明】
▸ v1.0已有基础scripts表（仅name字段），v1.1完善完整脚本表结构
▸ 已有脚本数据（v0.3阶段仅有name）需要在v1.1中进行数据迁移（添加其他字段）

【开发范围】
▸ 后端Agent：
  - 完善Prisma schema scripts表（全字段：前中后贴内容、标签、父子关系）
  - 实现 /api/scripts 增删改查接口（含权限校验）
  - 实现脚本名全局唯一校验接口 /api/scripts/check-name
  - 实现 prisma/seed.ts 标签初始数据（前/中/尾贴完整标签列表）
▸ 前端Agent：
  - 实现脚本管理页（列表视图 + 搜索筛选）
  - 实现脚本上传表单（含标签多选、衍生脚本字段动态显示）
  - 实现脚本详情弹窗（只读模式）
  - 实现权限控制（编辑按钮仅本人/管理员可见，删除按钮仅管理员可见）
  - 实现「以此脚本迭代」按钮（所有人可见）

【验收标准】
□ 编导可以填写完整表单并上传脚本
□ 脚本名重复时，前端实时报错，不可提交
□ 标签多选正常，已选标签以Tag形式展示
□ 选「是」时，衍生脚本字段动态展示
□ 脚本列表正常展示，搜索筛选功能正常
□ 编导无法看到他人脚本的编辑按钮
□ 所有人可以看到「以此脚本迭代」按钮
□ 管理员可删除任意脚本（二次确认）

v2.0  脚本管理页 — 完整版 + 数据关联打通
目标：脚本与数据分析完全打通，父子脚本关系可视化
【开发范围】
▸ 后端Agent：
  - 将脚本上传后自动触发与已有EXCEL数据的重新匹配
  - 完善父子脚本消耗聚合（支持多层衍生）
  - 实现标签管理接口（管理员增删改标签）
  - 实现用户管理接口（管理员禁用账号）
▸ 前端Agent：
  - 完善脚本管理页（编辑功能、管理员入口：标签管理/用户管理）
  - 数据分析页单脚本弹窗：完善父子脚本关联展示（列出所有子脚本）
  - 数据分析页：新脚本上传后图表自动刷新
▸ 测试Agent：
  - 端到端测试：上传脚本 → 匹配EXCEL → 数据图表更新全流程
  - 权限边界测试（编导无法通过API绕过权限）
  - 出具v2.0测试报告

【验收标准（产品负责人签收v2.0）】
□ 新上传脚本后，数据分析页该脚本数据自动更新
□ 父子脚本消耗关联在数据分析弹窗中正确展示
□ 标签管理功能正常（管理员增删改标签，历史快照不受影响）
□ 权限测试：编导无法通过任何方式删改他人脚本
□ ✅ 产品负责人正式确认：v2.0 脚本管理功能可投入日常使用

v3.0  AI二创页 — 完整版上线
目标：AI二创功能完整上线，全平台功能完整交付
【开发范围】
▸ 后端Agent：
  - 实现豆包（字节跳动）OAuth 2.0 授权接口对接
  - 实现通义千问（阿里云）OAuth 2.0 授权接口对接
  - 实现AI调用代理接口（不在前端暴露token）
  - 实现授权状态管理（session级别存储，刷新后失效）
▸ 前端Agent：
  - 实现AI二创页完整UI（优秀脚本展示 + 授权模块 + 二创工作台）
  - 实现豆包/千问授权弹窗（扫码/账密两种方式）
  - 实现四步二创工作流（选脚本→选段落→AI生成→录入上传）
  - 实现增加提示语、手动修改、重新生成、取消功能
  - 实现AI生成结果与「录入上传」的联动（自动建立父子关系）
▸ 测试Agent：
  - AI授权全流程测试（豆包+千问两个平台）
  - AI生成内容录入后父子关系正确建立测试
  - 授权token不在前端网络请求中暴露（安全测试）
  - 出具v3.0完整测试报告

【验收标准（产品负责人签收v3.0 — 全平台完整交付）】
□ 豆包授权（扫码）流程正常
□ 通义千问授权（账密）流程正常
□ 一键仿写功能正常，AI生成内容符合固定提示词要求
□ 增加提示语后重新生成功能正常
□ 录入上传后，新脚本在脚本列表中正常展示，父子关系正确
□ 全平台权限、数据、交互全部测试通过
□ ✅ 产品负责人正式确认：v3.0 全平台正式交付，可供全组日常使用
□ 📋 PDF导出功能（后续版本规划）：待v3.0稳定运行后启动开发

5.1 版本迭代总览
版本	核心交付	关键验收节点	主要参与Agent
v0.1	项目框架 + 账号系统 + 局域网部署	全组可访问网站，可登录注册	架构、后端、前端、部署
v0.2	EXCEL上传 + 状态提示 + 格式校验	管理员可上传EXCEL并看到全程状态反馈	后端、前端、测试
v0.3	数据匹配 + 聚合计算 + 基础图表	拟真数据测试通过，基础数据展示正确	后端、前端、测试（必须有拟真数据）
v1.0	数据分析页完整版	✅ 签收：数据分析功能可日常使用	全员
v1.1	脚本管理基础版	编导可上传脚本，权限控制正确	后端、前端、测试
v2.0	脚本管理完整版 + 数据关联打通	✅ 签收：脚本管理可日常使用	全员
v3.0	AI二创页完整版	✅ 签收：全平台正式交付	全员
后续版本	PDF导出功能	项目稳定后启动	后端、前端


六、账号系统（PRD保留）
见 v2.0 第三章，内容完全保留，在迭代路线 v0.1 阶段开发。

注册页面 /register
•表单：用户名（全平台唯一，2-20字符）、密码（至少6位）、确认密码
•重名报错：「该用户名已被使用，请重新命名」
•注册成功跳转至登录页
•后端接口：POST /api/auth/register

登录页面 /login
•管理员预置：用户名「管理员」密码「123456」
•JWT token鉴权，有效期7天
•连续失败5次锁定5分钟
•后端接口：POST /api/auth/login


七、首页脚本管理系统（PRD保留）
见 v2.0 第四章，内容完全保留，在迭代路线 v1.1 / v2.0 阶段开发。

权限矩阵（核心规则）
功能	超级管理员	编导（本人脚本）	编导（他人脚本）
上传脚本	✅	✅	❌
查看脚本内容	✅	✅	✅（只读）
编辑脚本	✅	✅（仅限本人）	❌（后端强制拦截）
删除脚本	✅	❌	❌（后端强制拦截）
以他人脚本迭代新建	✅	✅	✅

脚本名规则
•全平台强制唯一：重名时前端实时报错 + 后端二次校验，不可提交
•用户须自行调整命名，平台不做任何自动干预

标签体系
•前贴：促销、剧情、焦虑/共情、才艺、干货、提升、社交、实用价值、人设、课程卖点、受益者
•中段：发声技巧、情感带入、课程+对应福利、自我提升、角色塑造、应用场景、认知认同、案例分享、沟通技巧、营销免费
•尾贴：行为引导、时效性节点、福利加码、价格促销、收获引导、社交
•管理员可增删改标签，修改不影响历史脚本的标签快照


八、数据分析系统（PRD保留）
见 v2.0 第五章，内容完全保留，在迭代路线 v0.2 / v0.3 / v1.0 阶段分步开发。核心规则摘要如下：

匹配规则摘要
•模糊包含匹配：EXCEL A列「素材名」包含脚本名字符串即算匹配
•边界处理：「脚本3」不应匹配「脚本30」，脚本名两侧须做词边界检测
•多期累积：每次新上传EXCEL后，全量重新计算所有脚本统计数据
•广告渠道分组：C列渠道单独保留，支持全渠道汇总和按渠道查看

数据计算策略（关键字段）
字段	策略	字段	策略
总成本	加算	获客成本	重算：总成本÷总获客数
展示数、点击数	加算	平均展示/点击消耗	重算：总成本÷对应总量
获客数、高价课人数	加算	ROI	重算：高价课流水÷总成本
点击率、完播率等率类	多期平均数	激活成本、添加成本	重算：总成本÷对应总量
高价课流水、低价课流水	加算	退款率等率类	多期平均数


九、AI二创系统（PRD保留）
见 v2.0 第六章，内容完全保留，在迭代路线 v3.0 阶段开发。核心规则摘要：

•AI平台选择：豆包 或 通义千问，由编导自行选择并授权
•授权方式：扫码登录 或 账号密码登录，后端代理调用（不在前端暴露token）
•固定提示词：你是一个专业的信息流文案编导，请你参考原文，保留相同的字数及大致的格式，保留原文的产品及价格等信息，仿写一个新的段落，要求不能有信息流投放违规词，可以用其他的话术替代。
•录入上传：新脚本自动将参考脚本设为父脚本，父子关系自动建立


十、测试要求（PRD保留 + 分版本分配）
完整测试用例见 v2.0 第八章，以下按版本分配测试工作：

版本	测试重点	必测项
v0.1	账号系统功能	注册/登录/重名/锁定/JWT过期
v0.2	EXCEL上传状态流程	5个状态正确展示/格式校验/权限控制
v0.3	数据匹配精度（拟真数据）	模糊匹配/边界匹配/多期累积/重算字段（必须有拟真数据）
v1.0	数据分析页完整功能	所有图表/单脚本弹窗/渠道切换/性能测试
v1.1	脚本权限边界	编辑权限/删除权限/API越权请求拦截
v2.0	数据关联端到端	上传脚本→匹配数据→图表更新全链路
v3.0	AI授权安全	token不暴露/授权过期处理/父子关系正确建立



本PRD文档版本 v3.0，在 v2.0 基础上新增：技术栈评估、局域网部署方案、多Agent提示词规划、分阶段迭代路线图、EXCEL上传状态提示机制。
下一步行动：产品负责人确认 v3.0 内容无误后，启动 架构Agent 执行 v0.1 开发工作。